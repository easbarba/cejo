
#!/usr/bin/env ruby
# frozen_string_literal: true

require_relative '../lib/cejo'

require 'gli'
require 'dry-container'

# and then, there was fire.
class App
  extend GLI::App

  program_desc 'Debian automation and services utilities.'

  version Cejo::VERSION

  subcommand_option_handling :normal
  arguments :normal

  desc 'Describe some switch here'
  switch %i[s switch]

  desc 'Describe some flag here'
  default_value 'the default'
  arg_name 'The name of the argument'
  flag %i[f flagname]

  def self.services
    container = Dry::Container.new
    container.register :folders, Cejo::Services::Folders.new
    container.register :utils, Cejo::Services::Utils.new
  end

  desc 'Front-end of system utilities, services and programs.'
  arg_name 'Describe arguments to ops here'
  command :ops do |c|
    utils = services.resolve :utils

    c.desc 'Manage System Volume'
    c.arg '[up, down, toggle]'
    c.command :volume do |volume|
      volume.action do |_, _, args|
        Cejo::Ops::Volume.new(utils, args.first).run
      end
    end

    c.desc 'Mirror user DATA partition folders to $HOME'
    c.arg '/folder/path/'
    c.command :homey do |homey|
      homey.action do |_, _, args|
        Cejo::Ops::Homey.new(args.first).run
      end
    end

    c.desc 'Mirror Lar files in $HOME.'
    c.arg '/folder/path/'
    c.command :dots do |dots|
      dots.action do |_, _, args|
        Cejo::Ops::Dots.new(utils, args.first).run
      end
    end

    c.desc 'Display System Hardware Information.'
    c.command :sysinfo do |sysinfo|
      sysinfo.action do
        Cejo::Ops::Sysinfo.new(utils).run
      end
    end

    c.desc 'Take a shot of current screen'
    c.arg '[full, partial]'
    c.command :screenshot do |screenshot|
      screenshot.action do |_, _, args|
        Cejo::Ops::Screenshot.new(utils, args.first).run
      end
    end

    c.desc 'Manage system brightness.'
    c.arg '[up down]'
    c.command :brightness do |brightness|
      brightness.action do |_, _, args|
        Cejo::Ops::Brightness.new(utils, args.first).run
      end
    end
  end

  desc 'Manage and grab media'
  command :media do |c|
    c.desc 'Get media pointed in url as video or audio.'
    c.arg '[[vorbis, flac, mkv, mp3, mp4] <url>]'
    c.command :get do |get|
      get.action do |_, _, args|
        codec = args.first if args
        media = args.last if args.last
        Cejo::Media::Main.new(codec, media).run
      end
    end

    c.desc 'Play file, random media in folder or media pointed in url. (mpv)'
    c.arg '[url, /path/to/folder, /path/to/file]'
    c.command :play do |play|
      play.action do |_, _, args|
        Cejo::Media::Play.new(args.first).run
      end
    end
  end

  desc 'Install local builds of FLOSS Projects.'
  arg_name 'Name of project'
  command :projects do |build|
    build.action do |_, _, args|
      Cejo::Projects::Main.new(services, args.first).run
    end
  end

  desc 'Grab Floss Projects Repositories source'
  arg_name 'Describe arguments to floss here'
  command :floss do |c|
    utils = services.resolve(:utils)
    folders = services.resolve(:folders)

    c.desc 'Archive FLOSS Projects'
    c.command :archive do |archive|
      archive.action do
        Cejo::Floss::Main.new(folders, utils, :archive).run
      end
    end

    c.desc 'Grab FLOSS Projects'
    c.command :grab do |grab|
      grab.action do
        Cejo::Floss::Main.new(folders, utils, :grab).run
      end
    end
  end

  # pre do |global, command, options, args|
  #   # Pre logic here
  #   # Return true to proceed; false to abort and not call the
  #   # chosen command
  #   # Use skips_pre before a command to skip this block
  #   # on that command only
  #   true
  # end

  # post do |global, command, options, args|
  #   # Post logic here
  #   # Use skips_post before a command to skip this
  #   # block on that command only
  # end

  # on_error do |exception|
  #   # Error logic here
  #   # return false to skip default error handling
  #   true
  # end
end

exit App.run(ARGV)
